<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Query Execution Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; }
        .app { max-width: 1200px; margin: 0 auto; padding: 32px 24px 48px; }
        h1 { font-size: 28px; margin-bottom: 8px; }
        h2 { margin: 24px 0 12px; font-size: 18px; }
        .card { background: #111827; border: 1px solid #1f2937; border-radius: 14px; padding: 18px 16px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
        .flex { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #cbd5e1; }
        input, textarea, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #1f2937; background: #0b1220; color: #e2e8f0; box-sizing: border-box; }
        button { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        button:disabled { opacity: 0.55; cursor: not-allowed; }
        .muted { color: #94a3b8; font-size: 13px; }
        .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; }
        .pill.success { background: rgba(34,197,94,0.15); color: #22c55e; }
        .pill.error { background: rgba(248,113,113,0.15); color: #f87171; }
        .pill.info { background: rgba(59,130,246,0.18); color: #60a5fa; }
        .panel { max-height: 200px; overflow: auto; background: #0b1220; padding: 12px; border-radius: 12px; border: 1px solid #1f2937; white-space: pre-wrap; }
        .stack { display: flex; flex-direction: column; gap: 14px; }
        .status-line { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .role-toggle { margin: 8px 0 0; font-size: 14px; color: #cbd5e1; }
        .divider { height: 1px; background: #1f2937; margin: 12px 0; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const API_BASE = '';

    function decodeRole(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.role || payload.authorities || null;
        } catch (e) {
            return null;
        }
    }

    const usePollingJob = (token, jobId, onComplete) => {
        React.useEffect(() => {
            if (!jobId || !token) return;
            let cancelled = false;
            const poll = async () => {
                try {
                    const res = await fetch(`${API_BASE}/queries/job/${jobId}`, {
                        headers: { Authorization: `Bearer ${token}` },
                    });
                    const data = await res.json();
                    if (cancelled) return;
                    onComplete(data);
                    if (data.status === 'RUNNING') {
                        setTimeout(poll, 1000);
                    }
                } catch (err) {
                    if (!cancelled) {
                        onComplete({ status: 'FAILED', error: err.message });
                    }
                }
            };
            poll();
            return () => { cancelled = true; };
        }, [token, jobId, onComplete]);
    };

    function LoginForm({ onAuthenticated }) {
        const [username, setUsername] = React.useState('');
        const [password, setPassword] = React.useState('');
        const [error, setError] = React.useState(null);
        const [loading, setLoading] = React.useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError(null);
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.message || data.error || 'Login failed');
                }
                onAuthenticated(data.token);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="card" style={{ maxWidth: 460, margin: '0 auto' }}>
                <h2>Sign in</h2>
                <form className="stack" onSubmit={handleSubmit}>
                    <div>
                        <label>Username</label>
                        <input value={username} onChange={(e) => setUsername(e.target.value)} required />
                    </div>
                    <div>
                        <label>Password</label>
                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                    </div>
                    {error && <div className="pill error">{error}</div>}
                    <button type="submit" disabled={loading}>{loading ? 'Signing in...' : 'Login'}</button>
                </form>
            </div>
        );
    }

    function QueryWorkspace({ token, role }) {
        const [queries, setQueries] = React.useState([]);
        const [newQuery, setNewQuery] = React.useState('');
        const [createError, setCreateError] = React.useState(null);
        const [executeTarget, setExecuteTarget] = React.useState('');
        const [jobId, setJobId] = React.useState(null);
        const [jobState, setJobState] = React.useState(null);
        const [userMsg, setUserMsg] = React.useState(null);

        const fetchQueries = React.useCallback(async () => {
            try {
                const res = await fetch(`${API_BASE}/queries`, {
                    headers: { Authorization: `Bearer ${token}` },
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || data.error || 'Failed to load queries');
                setQueries(data);
            } catch (err) {
                setUserMsg({ type: 'error', text: err.message });
            }
        }, [token]);

        React.useEffect(() => { fetchQueries(); }, [fetchQueries]);

        const submitQuery = async () => {
            setCreateError(null);
            try {
                const res = await fetch(`${API_BASE}/queries`, {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'text/plain',
                    },
                    body: newQuery,
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || data.error || 'Unable to save query');
                setNewQuery('');
                setExecuteTarget(data.id);
                setUserMsg({ type: 'info', text: 'Query saved successfully.' });
                fetchQueries();
            } catch (err) {
                setCreateError(err.message);
            }
        };

        const executeQuery = async () => {
            if (!executeTarget) return;
            setUserMsg(null);
            setJobState({ status: 'RUNNING', message: 'Submitting job...' });
            try {
                const res = await fetch(`${API_BASE}/queries/execute?queryId=${executeTarget}`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${token}` },
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || data.error || 'Failed to execute');
                setJobId(data.jobId);
                setJobState({ status: data.status, message: 'Job submitted.' });
            } catch (err) {
                setJobId(null);
                setJobState({ status: 'FAILED', error: err.message });
                setUserMsg({ type: 'error', text: err.message });
            }
        };

        const handleJobUpdate = React.useCallback((data) => {
            setJobState(data);
            if (data.status && data.status !== 'RUNNING') {
                setUserMsg({ type: data.status === 'SUCCEEDED' ? 'success' : 'error', text: data.error || data.message || `Job ${data.status.toLowerCase()}` });
            }
        }, []);

        usePollingJob(token, jobId, handleJobUpdate);

        const statusPill = (state) => {
            if (!state) return null;
            if (state.status === 'RUNNING') return <span className="pill info">Running...</span>;
            if (state.status === 'SUCCEEDED') return <span className="pill success">Succeeded</span>;
            return <span className="pill error">Failed</span>;
        };

        return (
            <div className="stack">
                <div className="card">
                    <div className="status-line">
                        <h2>Queries</h2>
                        <button onClick={fetchQueries}>Refresh</button>
                    </div>
                    <div className="panel" aria-label="Existing queries">
                        {queries.length === 0 ? (
                            <div className="muted">No queries yet.</div>
                        ) : (
                            queries.map((q) => (
                                <div key={q.id} style={{ marginBottom: 10 }}>
                                    <div className="muted">#{q.id}</div>
                                    <div style={{ fontWeight: 600 }}>{q.query}</div>
                                </div>
                            ))
                        )}
                    </div>
                </div>

                <div className="grid">
                    <div className="card stack">
                        <div>
                            <label>Store a new query</label>
                            <textarea rows="5" value={newQuery} onChange={(e) => setNewQuery(e.target.value)} placeholder="Write SQL here..." />
                            {createError && <div className="pill error" style={{ marginTop: 8 }}>{createError}</div>}
                            <button onClick={submitQuery} disabled={!newQuery.trim()}>Save query</button>
                        </div>
                    </div>

                    <div className="card stack">
                        <div className="stack">
                            <div>
                                <label>Select query to execute</label>
                                <select value={executeTarget} onChange={(e) => setExecuteTarget(e.target.value)}>
                                    <option value="">Choose query</option>
                                    {queries.map((q) => (
                                        <option key={q.id} value={q.id}>#{q.id} — {q.query.slice(0, 35)}</option>
                                    ))}
                                </select>
                            </div>
                            <button onClick={executeQuery} disabled={!executeTarget}>Run query</button>
                            <div className="divider" />
                            <div className="status-line">
                                <div>
                                    <div className="muted">Job status</div>
                                    <div>{jobId ? `Job #${jobId}` : 'No job yet'}</div>
                                </div>
                                {statusPill(jobState)}
                            </div>
                            {jobState && jobState.error && <div className="pill error">{jobState.error}</div>}
                            {jobState && jobState.result && <div className="panel">{jobState.result}</div>}
                            {jobState && jobState.message && !jobState.result && <div className="muted">{jobState.message}</div>}
                        </div>
                    </div>
                </div>

                {userMsg && (
                    <div className={`pill ${userMsg.type === 'success' ? 'success' : userMsg.type === 'error' ? 'error' : 'info'}`}>
                        {userMsg.text}
                    </div>
                )}
            </div>
        );
    }

    function AdminPanel({ token }) {
        const [username, setUsername] = React.useState('');
        const [password, setPassword] = React.useState('');
        const [role, setRole] = React.useState('USER');
        const [feedback, setFeedback] = React.useState(null);

        const createUser = async () => {
            setFeedback(null);
            try {
                const res = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password, role }),
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || data.error || 'Failed to create user');
                setFeedback({ type: 'success', text: `User ${data.username} created.` });
                setUsername('');
                setPassword('');
                setRole('USER');
            } catch (err) {
                setFeedback({ type: 'error', text: err.message });
            }
        };

        return (
            <div className="card" style={{ marginTop: 16 }}>
                <h2>Admin — Create user</h2>
                <div className="grid">
                    <div className="stack">
                        <div>
                            <label>Username</label>
                            <input value={username} onChange={(e) => setUsername(e.target.value)} placeholder="new username" />
                        </div>
                        <div>
                            <label>Password</label>
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="temporary password" />
                        </div>
                        <div>
                            <label>Role</label>
                            <select value={role} onChange={(e) => setRole(e.target.value)}>
                                <option value="USER">USER</option>
                                <option value="ADMIN">ADMIN</option>
                            </select>
                        </div>
                        <button onClick={createUser} disabled={!username || !password}>Create user</button>
                        {feedback && <div className={`pill ${feedback.type === 'success' ? 'success' : 'error'}`}>{feedback.text}</div>}
                    </div>
                </div>
            </div>
        );
    }

    function App() {
        const [token, setToken] = React.useState(localStorage.getItem('jwt') || null);
        const [role, setRole] = React.useState(token ? decodeRole(token) : null);

        const handleAuth = (newToken) => {
            localStorage.setItem('jwt', newToken);
            setToken(newToken);
            setRole(decodeRole(newToken));
        };

        const logout = () => {
            localStorage.removeItem('jwt');
            setToken(null);
            setRole(null);
        };

        if (!token) {
            return (
                <div className="app">
                    <h1>Query Execution Service</h1>
                    <p className="muted">Sign in to manage and execute queries.</p>
                    <LoginForm onAuthenticated={handleAuth} />
                </div>
            );
        }

        return (
            <div className="app">
                <div className="status-line">
                    <div>
                        <h1>Query Execution Service</h1>
                        <div className="role-toggle">Signed in as <strong>{role || 'User'}</strong></div>
                    </div>
                    <div className="flex">
                        <button onClick={logout} style={{ background: '#ef4444' }}>Logout</button>
                    </div>
                </div>

                <QueryWorkspace token={token} role={role} />
                {role === 'ADMIN' && <AdminPanel token={token} />}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>